# 🚀 快速升级指南 - v2.0

## 📋 升级内容

本次升级包含两个主要改动：

### 1. **功能升级** 
- ✅ 新增阅读记录管理模块
- ✅ 支持添加和管理书籍
- ✅ 追踪阅读进度和完成状态
- ✅ 阅读统计功能

### 2. **数据管理优化**
- ✅ MySQL数据从Docker卷迁移到本地目录
- ✅ 数据位置：`./data/mysql/`
- ✅ 更方便备份和管理

---

## ⚡ 一键升级（推荐）

如果你**已经部署了旧版本**，使用一键升级脚本：

```bash
# 1. 进入项目目录
cd /opt/eleven_study

# 2. 如果需要，设置MySQL密码（如果你改过默认密码）
export MYSQL_ROOT_PASSWORD=你的密码

# 3. 运行升级脚本
./upgrade-and-mount.sh
```

### 脚本会自动完成：
1. ✅ 备份当前数据
2. ✅ 停止服务
3. ✅ 迁移数据到 `./data/mysql`
4. ✅ 更新数据库结构（添加书籍和阅读记录表）
5. ✅ 重新构建并启动服务
6. ✅ 验证升级结果

---

## 📝 手动升级步骤

如果你想手动控制每一步：

### 步骤1：备份数据

```bash
cd /opt/eleven_study

# 创建备份目录
mkdir -p backups

# 备份数据库
docker compose exec mysql mysqldump -uroot -p密码 --all-databases > backups/backup_$(date +%Y%m%d).sql
```

### 步骤2：停止服务

```bash
docker compose down
```

### 步骤3：迁移数据到本地目录

```bash
# 创建数据目录
mkdir -p ./data/mysql

# 从Docker卷复制数据
docker run --rm \
    -v eleven_study_mysql_data:/source:ro \
    -v $(pwd)/data/mysql:/target \
    alpine \
    sh -c "cp -av /source/. /target/"
```

### 步骤4：更新代码

```bash
# 如果是从git拉取
git pull

# 或者重新上传所有文件
```

### 步骤5：更新数据库

```bash
# 启动MySQL
docker compose up -d mysql

# 等待启动
sleep 20

# 执行迁移脚本
docker compose exec -T mysql mysql -uroot -p密码 literacy_db < migrate-add-reading.sql
```

### 步骤6：重新构建服务

```bash
# 安装前端依赖（如果没有npm，用Docker）
docker run --rm \
    -v $(pwd)/frontend:/app \
    -w /app \
    node:18-alpine \
    sh -c "npm install --legacy-peer-deps"

# 重新构建
docker compose build --no-cache

# 启动所有服务
docker compose up -d
```

### 步骤7：验证

```bash
# 查看服务状态
docker compose ps

# 验证数据
docker compose exec mysql mysql -uroot -p密码 -e "USE literacy_db; SHOW TABLES;"
```

---

## 🆕 首次部署（全新安装）

如果是**首次部署**，使用初始化脚本：

```bash
# 1. 上传所有文件到服务器
cd /opt/eleven_study

# 2. 运行初始化脚本
./init-setup.sh

# 或者（CentOS 7专用）
./deploy-centos7.sh
```

---

## ✅ 验证升级

### 1. 检查服务状态

```bash
docker compose ps
```

应该看到三个服务都是 `Up` 状态：
- literacy-mysql
- literacy-backend
- literacy-frontend

### 2. 访问网站

打开浏览器访问：`http://服务器IP`

应该能看到新增的"阅读记录"菜单

### 3. 验证数据

```bash
# 查看数据目录
ls -lh ./data/mysql

# 验证数据库表
docker compose exec mysql mysql -uroot -p密码 -e "
USE literacy_db; 
SELECT COUNT(*) as word_count FROM words;
SELECT COUNT(*) as book_count FROM books;
"
```

---

## 🔄 版本对比

| 功能 | v1.0 | v2.0 |
|------|------|------|
| 汉字学习 | ✅ | ✅ |
| 星星奖励 | ✅ | ✅ |
| 每周统计 | ✅ | ✅ |
| 阅读记录 | ❌ | ✅ 新增 |
| 书籍管理 | ❌ | ✅ 新增 |
| 阅读进度 | ❌ | ✅ 新增 |
| 数据位置 | Docker卷 | 本地目录 |
| 备份方式 | 复杂 | 简单 |

---

## 📊 数据存储变化

### v1.0（旧版）
```
数据位置：/var/lib/docker/volumes/eleven_study_mysql_data/
访问方式：需要Docker命令
备份：docker命令导出
```

### v2.0（新版）
```
数据位置：/opt/eleven_study/data/mysql/
访问方式：直接访问文件系统
备份：直接复制目录
```

---

## 💾 备份建议

### 升级前备份（必须）

```bash
# SQL导出
docker compose exec mysql mysqldump -uroot -p密码 --all-databases > backup.sql
```

### 升级后备份（建议）

```bash
# 方法1：SQL导出
docker compose exec mysql mysqldump -uroot -p密码 literacy_db > backup.sql

# 方法2：目录备份（需停服）
docker compose stop mysql
tar -czf mysql_backup.tar.gz ./data/mysql/
docker compose start mysql

# 方法3：在线复制（可能不一致）
cp -r ./data/mysql ./data/mysql_backup
```

---

## ⚠️ 注意事项

### 1. 磁盘空间

升级前确保有足够空间（至少是数据库大小的2倍）：

```bash
# 查看磁盘空间
df -h

# 查看数据库大小
docker compose exec mysql mysql -uroot -p密码 -e "
SELECT 
    table_schema AS 'Database',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'literacy_db'
GROUP BY table_schema;
"
```

### 2. MySQL密码

如果你修改过MySQL密码，记得设置环境变量：

```bash
export MYSQL_ROOT_PASSWORD=你的实际密码
```

### 3. 网络访问

确保防火墙开放80端口：

```bash
# CentOS 7
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload

# Ubuntu
sudo ufw allow 80/tcp
```

### 4. 旧数据卷

升级成功后，旧的Docker卷还保留着，确认无误后可删除：

```bash
# 查看Docker卷
docker volume ls

# 删除旧卷（确认数据无误后）
docker volume rm eleven_study_mysql_data
```

---

## 🔧 故障排查

### 问题1：升级脚本失败

**症状**：脚本执行到某一步报错

**解决**：
1. 查看错误信息
2. 手动执行失败的步骤
3. 如果数据库连接失败，检查密码
4. 如果文件权限问题，使用 `sudo`

### 问题2：网站无法访问

**检查步骤**：

```bash
# 1. 查看服务状态
docker compose ps

# 2. 查看日志
docker compose logs frontend
docker compose logs backend
docker compose logs mysql

# 3. 检查端口
netstat -tlnp | grep 80

# 4. 重启服务
docker compose restart
```

### 问题3：数据丢失

**恢复数据**：

```bash
# 如果有备份文件
docker compose exec -T mysql mysql -uroot -p密码 < backup.sql

# 如果旧Docker卷还在
docker volume ls | grep mysql
# 可以重新迁移
```

### 问题4：前端依赖安装失败

**解决**：

```bash
# 清理缓存重试
docker run --rm \
    -v $(pwd)/frontend:/app \
    -w /app \
    node:18-alpine \
    sh -c "rm -rf node_modules package-lock.json && npm install --legacy-peer-deps"
```

### 问题5：权限错误

**症状**：`Can't create/write to file`

**解决**：
```bash
# 修复数据目录权限
sudo chown -R 999:999 ./data/mysql
sudo chmod -R 750 ./data/mysql
```

---

## 📞 获取帮助

### 查看日志

```bash
# 查看所有服务日志
docker compose logs

# 查看特定服务日志
docker compose logs mysql
docker compose logs backend
docker compose logs frontend

# 实时查看日志
docker compose logs -f
```

### 查看容器状态

```bash
# 服务状态
docker compose ps

# 详细信息
docker compose ps -a

# 资源使用
docker stats
```

### 重启服务

```bash
# 重启所有服务
docker compose restart

# 重启特定服务
docker compose restart mysql

# 完全重建
docker compose down
docker compose up -d --build
```

---

## 🎯 升级后配置

### 1. 修改MySQL密码（可选）

```bash
# 进入MySQL容器
docker compose exec mysql mysql -uroot -ppassword

# 修改密码
ALTER USER 'root'@'%' IDENTIFIED BY '新密码';
FLUSH PRIVILEGES;

# 同时更新 .env 文件或 docker-compose.yml
```

### 2. 设置定期备份

```bash
# 创建备份脚本
cat > /opt/eleven_study/daily-backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/eleven_study/backups"
DATE=$(date +%Y%m%d)
docker compose exec -T mysql mysqldump -uroot -ppassword literacy_db > $BACKUP_DIR/daily_$DATE.sql
gzip $BACKUP_DIR/daily_$DATE.sql
find $BACKUP_DIR -name "daily_*.sql.gz" -mtime +7 -delete
EOF

chmod +x /opt/eleven_study/daily-backup.sh

# 添加到crontab（每天凌晨2点）
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/eleven_study/daily-backup.sh") | crontab -
```

### 3. 监控磁盘空间

```bash
# 查看数据目录大小
du -sh /opt/eleven_study/data/mysql

# 设置磁盘空间监控
df -h | grep -E '/$|/opt'
```

---

## ✨ 新功能使用

### 阅读记录模块

1. **添加书籍**
   - 点击"阅读记录"菜单
   - 点击"添加新书"
   - 填写书名、作者等信息

2. **开始阅读**
   - 在书籍列表找到要读的书
   - 点击"开始阅读"

3. **更新进度**
   - 点击书籍卡片
   - 输入当前页数

4. **完成阅读**
   - 点击"标记完成"

更多详情请查看：`阅读记录功能说明.md`

---

## 📚 相关文档

- [阅读记录功能说明.md](./阅读记录功能说明.md) - 新功能详细说明
- [数据挂载说明.md](./数据挂载说明.md) - 数据管理详细说明
- [README.md](./README.md) - 项目完整文档

---

## ✅ 升级检查清单

完成升级后，请确认以下项目：

- [ ] 所有Docker容器正常运行
- [ ] 网站可以正常访问
- [ ] 原有汉字数据完整
- [ ] 原有学习记录完整
- [ ] "阅读记录"菜单可见
- [ ] 可以添加新书籍
- [ ] 数据存储在 `./data/mysql` 目录
- [ ] 备份文件已保存

---

祝升级顺利！🎉 如有问题，请查看日志或按照故障排查步骤操作。

