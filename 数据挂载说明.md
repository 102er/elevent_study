# 📁 MySQL数据挂载到磁盘说明

## 🎯 目的

将MySQL数据从Docker命名卷改为挂载到宿主机的具体目录，方便：
- ✅ 直接访问和备份数据
- ✅ 跨主机迁移数据
- ✅ 使用外部工具管理数据
- ✅ 更好地监控磁盘使用

---

## 📊 配置对比

### 修改前（Docker命名卷）
```yaml
volumes:
  - mysql_data:/var/lib/mysql  # Docker管理的卷

volumes:
  mysql_data:
    driver: local
```

**位置**：`/var/lib/docker/volumes/eleven_study_mysql_data/`

**优点**：Docker自动管理
**缺点**：不容易访问和备份

---

### 修改后（本地目录挂载）
```yaml
volumes:
  - ./data/mysql:/var/lib/mysql  # 项目目录下的data/mysql
```

**位置**：`/opt/eleven_study/data/mysql/`

**优点**：
- ✅ 直接访问数据文件
- ✅ 方便备份（直接复制目录）
- ✅ 容易迁移到其他服务器
- ✅ 可以用外部工具查看

---

## 🔄 迁移方法

### 方法一：使用迁移脚本（推荐）

适用于**已有数据**需要迁移的情况：

```bash
cd /opt/eleven_study

# 运行迁移脚本
./migrate-to-local-volume.sh
```

脚本会自动：
1. ✅ 备份当前数据
2. ✅ 停止服务
3. ✅ 从Docker卷复制数据到 `./data/mysql`
4. ✅ 重启服务
5. ✅ 验证数据完整性

---

### 方法二：全新部署

适用于**首次部署**或**可以重建数据**的情况：

```bash
cd /opt/eleven_study

# 创建数据目录
mkdir -p ./data/mysql

# 启动服务
docker compose up -d
```

系统会自动初始化数据库。

---

## 📂 目录结构

```
/opt/eleven_study/
├── data/
│   └── mysql/              ← MySQL数据目录
│       ├── ibdata1         # InnoDB系统表空间
│       ├── literacy_db/    # 应用数据库目录
│       ├── mysql/          # MySQL系统数据库
│       ├── performance_schema/
│       └── sys/
├── backups/                # 备份目录
│   └── backup_*.sql
├── docker-compose.yml
└── ...
```

---

## 💾 备份方法

### 方法一：SQL导出（推荐）

```bash
# 备份所有数据库
docker compose exec mysql mysqldump -uroot -p密码 --all-databases > backup.sql

# 只备份应用数据库
docker compose exec mysql mysqldump -uroot -p密码 literacy_db > backup.sql
```

### 方法二：直接复制数据目录

```bash
# 停止MySQL服务
docker compose stop mysql

# 复制整个数据目录
tar -czf mysql_backup_$(date +%Y%m%d).tar.gz ./data/mysql/

# 重启服务
docker compose start mysql
```

### 方法三：在线热备份

```bash
# 不停服直接复制（数据可能不一致，建议先做SQL导出）
cp -r ./data/mysql ./data/mysql_backup_$(date +%Y%m%d)
```

---

## 🔄 数据恢复

### 从SQL备份恢复

```bash
# 停止服务
docker compose down

# 清空数据目录
rm -rf ./data/mysql/*

# 启动服务（会初始化新的数据库）
docker compose up -d

# 等待MySQL启动
sleep 20

# 导入备份
docker compose exec -T mysql mysql -uroot -p密码 < backup.sql
```

### 从目录备份恢复

```bash
# 停止服务
docker compose down

# 恢复数据目录
rm -rf ./data/mysql
tar -xzf mysql_backup_20241028.tar.gz

# 启动服务
docker compose up -d
```

---

## 🔒 权限设置

### Linux权限配置

```bash
# 创建数据目录
mkdir -p ./data/mysql

# 设置权限（MySQL需要999:999）
sudo chown -R 999:999 ./data/mysql
sudo chmod -R 750 ./data/mysql
```

### 如果遇到权限问题

```bash
# 查看当前权限
ls -la ./data/

# 修复权限
sudo chown -R 999:999 ./data/mysql
```

---

## 🚀 迁移到其他服务器

### 步骤1：打包数据

```bash
# 在原服务器上
cd /opt/eleven_study

# 停止服务
docker compose down

# 打包整个项目
tar -czf literacy_project.tar.gz .

# 或者只打包数据
tar -czf mysql_data.tar.gz ./data/mysql
```

### 步骤2：传输到新服务器

```bash
# 使用scp传输
scp literacy_project.tar.gz user@new-server:/opt/

# 在新服务器上解压
ssh user@new-server
cd /opt
tar -xzf literacy_project.tar.gz
```

### 步骤3：启动服务

```bash
cd /opt/eleven_study

# 启动服务
docker compose up -d
```

---

## 📊 磁盘空间管理

### 查看磁盘使用

```bash
# 查看MySQL数据目录大小
du -sh ./data/mysql

# 查看详细的目录占用
du -h --max-depth=1 ./data/mysql
```

### 清理日志文件

```bash
# 进入MySQL容器
docker compose exec mysql bash

# 清理二进制日志
mysql -uroot -p -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"
```

---

## ⚠️ 注意事项

### 1. 不要在容器运行时直接修改数据文件

```bash
# ❌ 错误：容器运行时修改数据
cp ./data/mysql/literacy_db/users.ibd xxx

# ✅ 正确：先停止服务
docker compose stop mysql
# 然后再操作文件
```

### 2. 备份前确保数据一致性

```bash
# 推荐：使用mysqldump
docker compose exec mysql mysqldump -uroot -p密码 --single-transaction literacy_db > backup.sql

# 或者：停服后复制
docker compose stop mysql
cp -r ./data/mysql ./backup/
docker compose start mysql
```

### 3. Git忽略数据目录

已在`.gitignore`中添加：
```
# Database data
data/mysql/

# Backups  
backups/
```

---

## 🔍 故障排查

### 问题1：权限错误

**错误信息**：`Can't create/write to file '/var/lib/mysql/...`

**解决方法**：
```bash
sudo chown -R 999:999 ./data/mysql
sudo chmod -R 750 ./data/mysql
```

### 问题2：数据目录不存在

**错误信息**：`Can't find file: './literacy_db/xxx.frm'`

**解决方法**：
```bash
# 删除损坏的数据
docker compose down
rm -rf ./data/mysql

# 重新初始化
docker compose up -d
```

### 问题3：磁盘空间不足

**检查**：
```bash
df -h
du -sh ./data/mysql
```

**解决**：
```bash
# 清理日志
docker compose exec mysql mysql -uroot -p -e "PURGE BINARY LOGS BEFORE NOW();"

# 压缩备份
gzip ./backups/*.sql
```

---

## 📝 定期维护

### 每日任务

```bash
# 自动备份脚本（添加到crontab）
#!/bin/bash
BACKUP_DIR="/opt/eleven_study/backups"
DATE=$(date +%Y%m%d)

docker compose exec -T mysql mysqldump -uroot -p密码 literacy_db > $BACKUP_DIR/daily_$DATE.sql
gzip $BACKUP_DIR/daily_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "daily_*.sql.gz" -mtime +7 -delete
```

### 每周任务

```bash
# 优化表
docker compose exec mysql mysql -uroot -p -e "OPTIMIZE TABLE literacy_db.words, literacy_db.learning_records, literacy_db.books, literacy_db.reading_records;"

# 检查表
docker compose exec mysql mysql -uroot -p -e "CHECK TABLE literacy_db.words, literacy_db.learning_records;"
```

---

## ✅ 总结

### 优势

| 功能 | Docker卷 | 本地挂载 |
|------|---------|---------|
| 备份 | 需要容器 | 直接复制 |
| 迁移 | 复杂 | 简单 |
| 访问 | 困难 | 容易 |
| 管理 | Docker管理 | 手动管理 |
| 性能 | 较好 | 相同 |

### 建议

- ✅ 生产环境：使用本地挂载，方便备份
- ✅ 开发环境：可以使用Docker卷，更简单
- ✅ 定期备份：无论哪种方式都要定期备份

---

现在你的MySQL数据已经挂载到 `./data/mysql` 目录，可以直接访问和备份了！🎉

