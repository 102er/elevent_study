# ğŸ“ MySQLæ•°æ®æŒ‚è½½åˆ°ç£ç›˜è¯´æ˜

## ğŸ¯ ç›®çš„

å°†MySQLæ•°æ®ä»Dockerå‘½åå·æ”¹ä¸ºæŒ‚è½½åˆ°å®¿ä¸»æœºçš„å…·ä½“ç›®å½•ï¼Œæ–¹ä¾¿ï¼š
- âœ… ç›´æ¥è®¿é—®å’Œå¤‡ä»½æ•°æ®
- âœ… è·¨ä¸»æœºè¿ç§»æ•°æ®
- âœ… ä½¿ç”¨å¤–éƒ¨å·¥å…·ç®¡ç†æ•°æ®
- âœ… æ›´å¥½åœ°ç›‘æ§ç£ç›˜ä½¿ç”¨

---

## ğŸ“Š é…ç½®å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆDockerå‘½åå·ï¼‰
```yaml
volumes:
  - mysql_data:/var/lib/mysql  # Dockerç®¡ç†çš„å·

volumes:
  mysql_data:
    driver: local
```

**ä½ç½®**ï¼š`/var/lib/docker/volumes/eleven_study_mysql_data/`

**ä¼˜ç‚¹**ï¼šDockerè‡ªåŠ¨ç®¡ç†
**ç¼ºç‚¹**ï¼šä¸å®¹æ˜“è®¿é—®å’Œå¤‡ä»½

---

### ä¿®æ”¹åï¼ˆæœ¬åœ°ç›®å½•æŒ‚è½½ï¼‰
```yaml
volumes:
  - ./data/mysql:/var/lib/mysql  # é¡¹ç›®ç›®å½•ä¸‹çš„data/mysql
```

**ä½ç½®**ï¼š`/opt/eleven_study/data/mysql/`

**ä¼˜ç‚¹**ï¼š
- âœ… ç›´æ¥è®¿é—®æ•°æ®æ–‡ä»¶
- âœ… æ–¹ä¾¿å¤‡ä»½ï¼ˆç›´æ¥å¤åˆ¶ç›®å½•ï¼‰
- âœ… å®¹æ˜“è¿ç§»åˆ°å…¶ä»–æœåŠ¡å™¨
- âœ… å¯ä»¥ç”¨å¤–éƒ¨å·¥å…·æŸ¥çœ‹

---

## ğŸ”„ è¿ç§»æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨è¿ç§»è„šæœ¬ï¼ˆæ¨èï¼‰

é€‚ç”¨äº**å·²æœ‰æ•°æ®**éœ€è¦è¿ç§»çš„æƒ…å†µï¼š

```bash
cd /opt/eleven_study

# è¿è¡Œè¿ç§»è„šæœ¬
./migrate-to-local-volume.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… å¤‡ä»½å½“å‰æ•°æ®
2. âœ… åœæ­¢æœåŠ¡
3. âœ… ä»Dockerå·å¤åˆ¶æ•°æ®åˆ° `./data/mysql`
4. âœ… é‡å¯æœåŠ¡
5. âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§

---

### æ–¹æ³•äºŒï¼šå…¨æ–°éƒ¨ç½²

é€‚ç”¨äº**é¦–æ¬¡éƒ¨ç½²**æˆ–**å¯ä»¥é‡å»ºæ•°æ®**çš„æƒ…å†µï¼š

```bash
cd /opt/eleven_study

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p ./data/mysql

# å¯åŠ¨æœåŠ¡
docker compose up -d
```

ç³»ç»Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“ã€‚

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
/opt/eleven_study/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ mysql/              â† MySQLæ•°æ®ç›®å½•
â”‚       â”œâ”€â”€ ibdata1         # InnoDBç³»ç»Ÿè¡¨ç©ºé—´
â”‚       â”œâ”€â”€ literacy_db/    # åº”ç”¨æ•°æ®åº“ç›®å½•
â”‚       â”œâ”€â”€ mysql/          # MySQLç³»ç»Ÿæ•°æ®åº“
â”‚       â”œâ”€â”€ performance_schema/
â”‚       â””â”€â”€ sys/
â”œâ”€â”€ backups/                # å¤‡ä»½ç›®å½•
â”‚   â””â”€â”€ backup_*.sql
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ ...
```

---

## ğŸ’¾ å¤‡ä»½æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šSQLå¯¼å‡ºï¼ˆæ¨èï¼‰

```bash
# å¤‡ä»½æ‰€æœ‰æ•°æ®åº“
docker compose exec mysql mysqldump -uroot -på¯†ç  --all-databases > backup.sql

# åªå¤‡ä»½åº”ç”¨æ•°æ®åº“
docker compose exec mysql mysqldump -uroot -på¯†ç  literacy_db > backup.sql
```

### æ–¹æ³•äºŒï¼šç›´æ¥å¤åˆ¶æ•°æ®ç›®å½•

```bash
# åœæ­¢MySQLæœåŠ¡
docker compose stop mysql

# å¤åˆ¶æ•´ä¸ªæ•°æ®ç›®å½•
tar -czf mysql_backup_$(date +%Y%m%d).tar.gz ./data/mysql/

# é‡å¯æœåŠ¡
docker compose start mysql
```

### æ–¹æ³•ä¸‰ï¼šåœ¨çº¿çƒ­å¤‡ä»½

```bash
# ä¸åœæœç›´æ¥å¤åˆ¶ï¼ˆæ•°æ®å¯èƒ½ä¸ä¸€è‡´ï¼Œå»ºè®®å…ˆåšSQLå¯¼å‡ºï¼‰
cp -r ./data/mysql ./data/mysql_backup_$(date +%Y%m%d)
```

---

## ğŸ”„ æ•°æ®æ¢å¤

### ä»SQLå¤‡ä»½æ¢å¤

```bash
# åœæ­¢æœåŠ¡
docker compose down

# æ¸…ç©ºæ•°æ®ç›®å½•
rm -rf ./data/mysql/*

# å¯åŠ¨æœåŠ¡ï¼ˆä¼šåˆå§‹åŒ–æ–°çš„æ•°æ®åº“ï¼‰
docker compose up -d

# ç­‰å¾…MySQLå¯åŠ¨
sleep 20

# å¯¼å…¥å¤‡ä»½
docker compose exec -T mysql mysql -uroot -på¯†ç  < backup.sql
```

### ä»ç›®å½•å¤‡ä»½æ¢å¤

```bash
# åœæ­¢æœåŠ¡
docker compose down

# æ¢å¤æ•°æ®ç›®å½•
rm -rf ./data/mysql
tar -xzf mysql_backup_20241028.tar.gz

# å¯åŠ¨æœåŠ¡
docker compose up -d
```

---

## ğŸ”’ æƒé™è®¾ç½®

### Linuxæƒé™é…ç½®

```bash
# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p ./data/mysql

# è®¾ç½®æƒé™ï¼ˆMySQLéœ€è¦999:999ï¼‰
sudo chown -R 999:999 ./data/mysql
sudo chmod -R 750 ./data/mysql
```

### å¦‚æœé‡åˆ°æƒé™é—®é¢˜

```bash
# æŸ¥çœ‹å½“å‰æƒé™
ls -la ./data/

# ä¿®å¤æƒé™
sudo chown -R 999:999 ./data/mysql
```

---

## ğŸš€ è¿ç§»åˆ°å…¶ä»–æœåŠ¡å™¨

### æ­¥éª¤1ï¼šæ‰“åŒ…æ•°æ®

```bash
# åœ¨åŸæœåŠ¡å™¨ä¸Š
cd /opt/eleven_study

# åœæ­¢æœåŠ¡
docker compose down

# æ‰“åŒ…æ•´ä¸ªé¡¹ç›®
tar -czf literacy_project.tar.gz .

# æˆ–è€…åªæ‰“åŒ…æ•°æ®
tar -czf mysql_data.tar.gz ./data/mysql
```

### æ­¥éª¤2ï¼šä¼ è¾“åˆ°æ–°æœåŠ¡å™¨

```bash
# ä½¿ç”¨scpä¼ è¾“
scp literacy_project.tar.gz user@new-server:/opt/

# åœ¨æ–°æœåŠ¡å™¨ä¸Šè§£å‹
ssh user@new-server
cd /opt
tar -xzf literacy_project.tar.gz
```

### æ­¥éª¤3ï¼šå¯åŠ¨æœåŠ¡

```bash
cd /opt/eleven_study

# å¯åŠ¨æœåŠ¡
docker compose up -d
```

---

## ğŸ“Š ç£ç›˜ç©ºé—´ç®¡ç†

### æŸ¥çœ‹ç£ç›˜ä½¿ç”¨

```bash
# æŸ¥çœ‹MySQLæ•°æ®ç›®å½•å¤§å°
du -sh ./data/mysql

# æŸ¥çœ‹è¯¦ç»†çš„ç›®å½•å ç”¨
du -h --max-depth=1 ./data/mysql
```

### æ¸…ç†æ—¥å¿—æ–‡ä»¶

```bash
# è¿›å…¥MySQLå®¹å™¨
docker compose exec mysql bash

# æ¸…ç†äºŒè¿›åˆ¶æ—¥å¿—
mysql -uroot -p -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸è¦åœ¨å®¹å™¨è¿è¡Œæ—¶ç›´æ¥ä¿®æ”¹æ•°æ®æ–‡ä»¶

```bash
# âŒ é”™è¯¯ï¼šå®¹å™¨è¿è¡Œæ—¶ä¿®æ”¹æ•°æ®
cp ./data/mysql/literacy_db/users.ibd xxx

# âœ… æ­£ç¡®ï¼šå…ˆåœæ­¢æœåŠ¡
docker compose stop mysql
# ç„¶åå†æ“ä½œæ–‡ä»¶
```

### 2. å¤‡ä»½å‰ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

```bash
# æ¨èï¼šä½¿ç”¨mysqldump
docker compose exec mysql mysqldump -uroot -på¯†ç  --single-transaction literacy_db > backup.sql

# æˆ–è€…ï¼šåœæœåå¤åˆ¶
docker compose stop mysql
cp -r ./data/mysql ./backup/
docker compose start mysql
```

### 3. Gitå¿½ç•¥æ•°æ®ç›®å½•

å·²åœ¨`.gitignore`ä¸­æ·»åŠ ï¼š
```
# Database data
data/mysql/

# Backups  
backups/
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæƒé™é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`Can't create/write to file '/var/lib/mysql/...`

**è§£å†³æ–¹æ³•**ï¼š
```bash
sudo chown -R 999:999 ./data/mysql
sudo chmod -R 750 ./data/mysql
```

### é—®é¢˜2ï¼šæ•°æ®ç›®å½•ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š`Can't find file: './literacy_db/xxx.frm'`

**è§£å†³æ–¹æ³•**ï¼š
```bash
# åˆ é™¤æŸåçš„æ•°æ®
docker compose down
rm -rf ./data/mysql

# é‡æ–°åˆå§‹åŒ–
docker compose up -d
```

### é—®é¢˜3ï¼šç£ç›˜ç©ºé—´ä¸è¶³

**æ£€æŸ¥**ï¼š
```bash
df -h
du -sh ./data/mysql
```

**è§£å†³**ï¼š
```bash
# æ¸…ç†æ—¥å¿—
docker compose exec mysql mysql -uroot -p -e "PURGE BINARY LOGS BEFORE NOW();"

# å‹ç¼©å¤‡ä»½
gzip ./backups/*.sql
```

---

## ğŸ“ å®šæœŸç»´æŠ¤

### æ¯æ—¥ä»»åŠ¡

```bash
# è‡ªåŠ¨å¤‡ä»½è„šæœ¬ï¼ˆæ·»åŠ åˆ°crontabï¼‰
#!/bin/bash
BACKUP_DIR="/opt/eleven_study/backups"
DATE=$(date +%Y%m%d)

docker compose exec -T mysql mysqldump -uroot -på¯†ç  literacy_db > $BACKUP_DIR/daily_$DATE.sql
gzip $BACKUP_DIR/daily_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "daily_*.sql.gz" -mtime +7 -delete
```

### æ¯å‘¨ä»»åŠ¡

```bash
# ä¼˜åŒ–è¡¨
docker compose exec mysql mysql -uroot -p -e "OPTIMIZE TABLE literacy_db.words, literacy_db.learning_records, literacy_db.books, literacy_db.reading_records;"

# æ£€æŸ¥è¡¨
docker compose exec mysql mysql -uroot -p -e "CHECK TABLE literacy_db.words, literacy_db.learning_records;"
```

---

## âœ… æ€»ç»“

### ä¼˜åŠ¿

| åŠŸèƒ½ | Dockerå· | æœ¬åœ°æŒ‚è½½ |
|------|---------|---------|
| å¤‡ä»½ | éœ€è¦å®¹å™¨ | ç›´æ¥å¤åˆ¶ |
| è¿ç§» | å¤æ‚ | ç®€å• |
| è®¿é—® | å›°éš¾ | å®¹æ˜“ |
| ç®¡ç† | Dockerç®¡ç† | æ‰‹åŠ¨ç®¡ç† |
| æ€§èƒ½ | è¾ƒå¥½ | ç›¸åŒ |

### å»ºè®®

- âœ… ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨æœ¬åœ°æŒ‚è½½ï¼Œæ–¹ä¾¿å¤‡ä»½
- âœ… å¼€å‘ç¯å¢ƒï¼šå¯ä»¥ä½¿ç”¨Dockerå·ï¼Œæ›´ç®€å•
- âœ… å®šæœŸå¤‡ä»½ï¼šæ— è®ºå“ªç§æ–¹å¼éƒ½è¦å®šæœŸå¤‡ä»½

---

ç°åœ¨ä½ çš„MySQLæ•°æ®å·²ç»æŒ‚è½½åˆ° `./data/mysql` ç›®å½•ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å’Œå¤‡ä»½äº†ï¼ğŸ‰

