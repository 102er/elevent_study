# 🔄 更新说明 - 添加阅读记录功能

## ❓ 重新部署会清空数据吗？

### 简单回答

**不会！** 只要你使用正确的方法，所有现有数据都会保留。

---

## 📊 数据存储位置

你的数据存储在 **Docker 数据卷（Volume）**中：

```bash
# 查看数据卷
docker volume ls | grep literacy

# 应该看到：
# eleven_study_mysql_data  ← 你的所有数据都在这里
```

**只要这个数据卷不删除，数据就永远不会丢失！**

---

## ✅ 安全更新方法（推荐）

### 方法一：使用安全更新脚本（最简单）

```bash
cd /opt/eleven_study

# 一键安全更新（保留所有数据）
./safe-update.sh
```

这个脚本会：
- ✅ 自动备份数据（可选）
- ✅ 重新构建镜像
- ✅ 重启服务（不删除数据）
- ✅ 执行数据库迁移（只添加新表）
- ✅ 保留所有现有数据

---

### 方法二：手动更新（分步执行）

#### 1. 备份数据（推荐但非必需）

```bash
# 创建备份目录
mkdir -p backups

# 备份数据库
docker compose exec mysql mysqldump -uroot -p密码 literacy_db > backups/backup_$(date +%Y%m%d).sql
```

#### 2. 重新构建镜像

```bash
docker compose build --no-cache
```

#### 3. 重启服务（不删除数据卷）

```bash
# 停止容器（数据卷保留）
docker compose down

# 启动新容器
docker compose up -d
```

#### 4. 执行数据库迁移

```bash
# 等待MySQL启动
sleep 10

# 执行迁移脚本（添加新表）
docker compose exec -T mysql mysql -uroot -p密码 < migrate-add-reading.sql
```

#### 5. 验证数据

```bash
# 检查服务状态
docker compose ps

# 访问应用
curl http://localhost/

# 登录数据库检查
docker compose exec mysql mysql -uroot -p密码 -e "USE literacy_db; SHOW TABLES;"
```

---

## ❌ 危险操作（会删除数据）

### 千万不要这样做（除非你确定要重置）

```bash
# ⚠️ 危险！会删除所有数据
docker compose down -v

# ⚠️ 危险！会删除数据卷
docker volume rm eleven_study_mysql_data
```

**`-v` 参数会删除数据卷，导致所有数据丢失！**

---

## 🔍 数据检查命令

### 查看现有数据

```bash
# 进入MySQL容器
docker compose exec mysql mysql -uroot -p密码 literacy_db

# 在MySQL中执行：
SHOW TABLES;                        # 查看所有表
SELECT COUNT(*) FROM words;         # 查看汉字数量
SELECT COUNT(*) FROM learning_records;  # 查看学习记录数量
SELECT stars FROM star_records;     # 查看星星数量
SELECT COUNT(*) FROM books;         # 查看书籍数量
```

---

## 📦 更新后的数据库结构

### 现有表（保留）
- ✅ `words` - 汉字表
- ✅ `learning_records` - 学习记录表
- ✅ `star_records` - 星星记录表

### 新增表
- 🆕 `books` - 书籍表
- 🆕 `reading_records` - 阅读记录表

**所有现有数据完全保留，只是添加了新表！**

---

## 🎯 推荐更新流程

### 最安全的更新步骤

```bash
# 1. 进入项目目录
cd /opt/eleven_study

# 2. 查看当前服务状态
docker compose ps

# 3. 执行安全更新脚本
./safe-update.sh

# 4. 等待完成（约2-3分钟）

# 5. 访问应用验证
# 浏览器打开: http://服务器IP/
# 检查之前的学习记录是否还在
# 点击"阅读记录"测试新功能
```

---

## ⚡ 快速问答

### Q: 更新会影响现有的汉字和学习记录吗？
**A:** 不会！所有现有数据完全保留。

### Q: 需要重新添加汉字吗？
**A:** 不需要！之前添加的汉字都还在。

### Q: 之前的学习进度会丢失吗？
**A:** 不会！学习记录、星星数量、周统计都完整保留。

### Q: 更新需要多长时间？
**A:** 大约2-3分钟（取决于网络速度）。

### Q: 更新失败了怎么办？
**A:** 数据在数据卷中是安全的，可以重新运行更新脚本。

### Q: 可以回滚吗？
**A:** 可以！如果做了备份，可以恢复到之前的状态。

### Q: 什么时候数据会丢失？
**A:** 只有使用 `docker compose down -v` 命令时才会删除数据。

---

## 💾 数据恢复（如果需要）

### 从备份恢复

```bash
# 恢复数据库
docker compose exec -T mysql mysql -uroot -p密码 literacy_db < backups/backup_20241028.sql

# 重启服务
docker compose restart
```

---

## ✨ 更新后的新功能

更新完成后，你将拥有：

### 原有功能（完全保留）
- ✅ 识字学习
- ✅ 汉字库管理
- ✅ 学习进度
- ✅ 周统计
- ✅ 奖励系统

### 新增功能
- 🆕 阅读记录管理
- 🆕 书籍管理
- 🆕 阅读进度追踪
- 🆕 阅读统计

---

## 🎉 总结

### 记住这三点：

1. **使用 `./safe-update.sh`** - 最安全简单
2. **不要使用 `docker compose down -v`** - 会删除数据
3. **定期备份数据库** - 以防万一

**只要按照推荐方法，你的数据是100%安全的！** ✅

---

现在可以放心更新了！🚀

